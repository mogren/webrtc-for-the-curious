<!doctype html><html lang=zh dir=ltr><head><meta name=generator content="Hugo 0.74.3"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="调试 #  调试WebRTC可能是一项艰巨的任务。有很多部分都处于运行状态，每一个部分都可能出现问题。如果您不够细心，可能会浪费数周的时间来查看错误的模块。当您最终找到出错的部分时，您还需要学习一些知识才能理解它。
本章将带您学习WebRTC的调试。它将向您展示如何分析并定位相关问题。确定问题后，我们将快速介绍一下流行的调试工具。
分解问题 #  开始调试时，您需要先分析问题的根源。
信令故障 #  网络故障 #  使用netcat测试您的STUN服务器：
  准备20字节的绑定请求数据包：
echo -ne &#34;\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST&#34; | hexdump -C 00000000 00 01 00 00 21 12 a4 42 54 45 53 54 54 45 53 54 |....!..BTESTTEST| 00000010 54 45 53 54 |TEST| 00000014 解释：
  00 01 是消息类型
  00 00 是数据段的长度
  21 12 a4 42 是magic cookie
  54 45 53 54 54 45 53 54 54 45 53 54 （解码成ASCII就是TESTTESTTEST） 是12字节的transaction ID"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="调试"><meta property="og:description" content="调试 #  调试WebRTC可能是一项艰巨的任务。有很多部分都处于运行状态，每一个部分都可能出现问题。如果您不够细心，可能会浪费数周的时间来查看错误的模块。当您最终找到出错的部分时，您还需要学习一些知识才能理解它。
本章将带您学习WebRTC的调试。它将向您展示如何分析并定位相关问题。确定问题后，我们将快速介绍一下流行的调试工具。
分解问题 #  开始调试时，您需要先分析问题的根源。
信令故障 #  网络故障 #  使用netcat测试您的STUN服务器：
  准备20字节的绑定请求数据包：
echo -ne &#34;\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST&#34; | hexdump -C 00000000 00 01 00 00 21 12 a4 42 54 45 53 54 54 45 53 54 |....!..BTESTTEST| 00000010 54 45 53 54 |TEST| 00000014 解释：
  00 01 是消息类型
  00 00 是数据段的长度
  21 12 a4 42 是magic cookie
  54 45 53 54 54 45 53 54 54 45 53 54 （解码成ASCII就是TESTTESTTEST） 是12字节的transaction ID"><meta property="og:type" content="article"><meta property="og:url" content="https://webrtcforthecurious.com/zh/docs/09-debugging/"><meta property="article:modified_time" content="2021-04-14T13:50:11+09:00"><meta property="og:site_name" content="给好奇者的WebRTC"><title>调试 | 给好奇者的WebRTC</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=alternate hreflang=en href=https://webrtcforthecurious.com/docs/09-debugging/ title=Debugging><link rel=alternate hreflang=tr href=https://webrtcforthecurious.com/tr/docs/09-debugging/ title=Debugging><link rel=alternate hreflang=ja href=https://webrtcforthecurious.com/ja/docs/09-debugging/ title=デバッグ><link rel=stylesheet href=/book.min.6c7c6446dfdee7c8c933e9bbc6e80ee3ed6c913b2a59519f2092c3c6a9d63e55.css integrity="sha256-bHxkRt/e58jJM+m7xugO4+1skTsqWVGfIJLDxqnWPlU="><script defer src=/zh.search.min.8dd9371731cd9a129519a6b646015b5895192c02974f35109516889bf4b13dcf.js integrity="sha256-jdk3FzHNmhKVGaa2RgFbWJUZLAKXTzUQlRaIm/SxPc8="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/zh><span>给好奇者的WebRTC</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://webrtcforthecurious.com/zh/docs/01-what-why-and-how/>是什么，为什么，如何使用</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/02-signaling/>信令</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/03-connecting/>连接</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/04-securing/>安全性</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/05-real-time-networking/>搭建实时网络</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/06-media-communication/>媒体通信</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/07-data-communication/>数据通信</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/08-applied-webrtc/>WebRTC应用场景</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/09-debugging/ class=active>调试</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/10-history-of-webrtc/>历史</a></li><li><a href=https://webrtcforthecurious.com/zh/docs/11-faq/>常见问题</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>调试</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#分解问题>分解问题</a></li><li><a href=#用到的工具>用到的工具</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=调试>调试
<a class=anchor href=#%e8%b0%83%e8%af%95>#</a></h1><p>调试WebRTC可能是一项艰巨的任务。有很多部分都处于运行状态，每一个部分都可能出现问题。如果您不够细心，可能会浪费数周的时间来查看错误的模块。当您最终找到出错的部分时，您还需要学习一些知识才能理解它。</p><p>本章将带您学习WebRTC的调试。它将向您展示如何分析并定位相关问题。确定问题后，我们将快速介绍一下流行的调试工具。</p><h3 id=分解问题>分解问题
<a class=anchor href=#%e5%88%86%e8%a7%a3%e9%97%ae%e9%a2%98>#</a></h3><p>开始调试时，您需要先分析问题的根源。</p><h4 id=信令故障>信令故障
<a class=anchor href=#%e4%bf%a1%e4%bb%a4%e6%95%85%e9%9a%9c>#</a></h4><h4 id=网络故障>网络故障
<a class=anchor href=#%e7%bd%91%e7%bb%9c%e6%95%85%e9%9a%9c>#</a></h4><p>使用netcat测试您的STUN服务器：</p><ol><li><p>准备<strong>20字节</strong>的绑定请求数据包：</p><pre><code>echo -ne &quot;\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST&quot; | hexdump -C
00000000  00 01 00 00 21 12 a4 42  54 45 53 54 54 45 53 54  |....!..BTESTTEST|
00000010  54 45 53 54                                       |TEST|
00000014
</code></pre><p>解释：</p><ul><li><p><code>00 01</code> 是消息类型</p></li><li><p><code>00 00</code> 是数据段的长度</p></li><li><p><code>21 12 a4 42</code> 是magic cookie</p></li><li><p><code>54 45 53 54 54 45 53 54 54 45 53 54</code> （解码成ASCII就是<code>TESTTESTTEST</code>） 是12字节的transaction ID</p></li></ul></li><li><p>发送请求并等待<strong>32字节</strong>的响应：</p><pre><code>stunserver=stun1.l.google.com;stunport=19302;listenport=20000;echo -ne &quot;\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST&quot; | nc -u -p $listenport $stunserver $stunport -w 1 | hexdump -C
00000000  01 01 00 0c 21 12 a4 42  54 45 53 54 54 45 53 54  |....!..BTESTTEST|
00000010  54 45 53 54 00 20 00 08  00 01 6f 32 7f 36 de 89  |TEST. ....o2.6..|
00000020
</code></pre><p>解释：</p><ul><li><p><code>01 01</code> 是消息类型</p></li><li><p><code>00 0c</code> 是数据段的长度，解码后是十进制的12</p></li><li><p><code>21 12 a4 42</code> 是magic cookie</p></li><li><p><code>54 45 53 54 54 45 53 54 54 45 53 54</code> （解码成ASCII就是<code>TESTTESTTEST</code>）是12字节的transaction ID</p></li><li><p><code>00 20 00 08 00 01 6f 32 7f 36 de 89</code> 是12字节的数据，解释：</p><ul><li><p><code>00 20</code> 是类型：<code>XOR-MAPPED-ADDRESS</code></p></li><li><p><code>00 08</code> 是value段的长度，以十进制解码就是8</p></li><li><p><code>00 01 6f 32 7f 36 de 89</code> 是数据值，解释：</p><ul><li><p><code>00 01</code> 是地址类型（IPv4）</p></li><li><p><code>6f 32</code> 是经过XOR映射的端口</p></li><li><p><code>7f 36 de 89</code> 是经过XOR映射的IP地址</p></li></ul></li></ul></li></ul></li></ol><p>解码XOR映射的部分很麻烦，但是我们可以通过提供设置为<code>00 00 00 00</code>的（无效）伪magic cookie来诱骗stun服务器执行伪XOR映射：</p><pre><code>stunserver=stun1.l.google.com;stunport=19302;listenport=20000;echo -ne &quot;\x00\x01\x00\x00\x00\x00\x00\x00TESTTESTTEST&quot; | nc -u -p $listenport $stunserver $stunport -w 1 | hexdump -C
00000000  01 01 00 0c 00 00 00 00  54 45 53 54 54 45 53 54  |........TESTTEST|
00000010  54 45 53 54 00 01 00 08  00 01 4e 20 5e 24 7a cb  |TEST......N ^$z.|
00000020
</code></pre><p>对伪magic cookie的XOR运算是幂等的，因此响应中的端口和地址将是清楚的（这并非在所有情况下都有效，因为某些路由器会操纵传递的数据包，伪装IP地址）； 如果我们查看返回的数据值（最后八个字节）：</p><ul><li><p><code>00 01 4e 20 5e 24 7a cb</code> 是数据值，解释：</p><ul><li><p><code>00 01</code> 是地址类型（IPv4）</p></li><li><p><code>4e 20</code> 是映射的端口，解码成十进制就是20000</p></li><li><p><code>5e 24 7a cb</code> 是IP地址，解码成点分十进制表示法就是<code>94.36.122.203</code></p></li></ul></li></ul><h4 id=安全故障>安全故障
<a class=anchor href=#%e5%ae%89%e5%85%a8%e6%95%85%e9%9a%9c>#</a></h4><h4 id=媒体故障>媒体故障
<a class=anchor href=#%e5%aa%92%e4%bd%93%e6%95%85%e9%9a%9c>#</a></h4><h4 id=数据故障>数据故障
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e6%95%85%e9%9a%9c>#</a></h4><h3 id=用到的工具>用到的工具
<a class=anchor href=#%e7%94%a8%e5%88%b0%e7%9a%84%e5%b7%a5%e5%85%b7>#</a></h3><h4 id=netcat-nc>netcat (nc)
<a class=anchor href=#netcat-nc>#</a></h4><p><a href=https://en.wikipedia.org/wiki/Netcat>netcat</a> 是用于使用TCP或UDP读取和写入网络连接的命令行网络实用程序。通常它可以用<code>nc</code>命令来调用。</p><h4 id=tcpdump>tcpdump
<a class=anchor href=#tcpdump>#</a></h4><p><a href=https://en.wikipedia.org/wiki/Tcpdump>tcpdump</a>是一个命令行数据网络数据包分析器。</p><p>常用命令：</p><ul><li><p>捕获与端口19302之间的UDP数据包，并打印数据包内容的十六进制转储：</p><p><code>sudo tcpdump 'udp port 19302' -xx</code></p></li><li><p>与上一条相同，但将数据包保存在PCAP（数据包捕获）文件中以供以后检查</p><p><code>sudo tcpdump 'udp port 19302' -w stun.pcap</code></p><p>可以使用wireshark GUI打开PCAP文件：<code>wireshark stun.pcap</code></p></li></ul><h4 id=wireshark>wireshark
<a class=anchor href=#wireshark>#</a></h4><h4 id=webrtc-internals>webrtc-internals
<a class=anchor href=#webrtc-internals>#</a></h4></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
简体中文</li></ul><ul class=book-languages-list><li><a href=https://webrtcforthecurious.com/docs/09-debugging/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=https://webrtcforthecurious.com/tr/docs/09-debugging/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Turkish</a></li><li><a href=https://webrtcforthecurious.com/fa/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Persian</a></li><li><a href=https://webrtcforthecurious.com/ja/docs/09-debugging/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
日本語</a></li><li class=active><a href=https://webrtcforthecurious.com/zh/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
简体中文</a></li></ul></div><div><a class="flex align-center" href=https://github.com/webrtc-for-the-curious/webrtc-for-the-curious/commit/dc11c2ff3d8d11b30af6cfa81458c3507f77b452 title="最后修改者 Hiroyuki Sato | April 14, 2021" target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>April 14, 2021</span></a></div><div><a class="flex align-center" href=https://github.com/webrtc-for-the-curious/webrtc-for-the-curious/edit/master/content.zh-cn/docs/09-debugging.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#分解问题>分解问题</a></li><li><a href=#用到的工具>用到的工具</a></li></ul></li></ul></nav></div></aside></main></body></html>